var sessionSec,counter,carts;function addASMHandlers(){revertAutocompleteNormalize(),addCloseBtnHandler(),addASMFormHandler(),addHideBtnHandler(),addCustomerListBtnHandler(),customerListModalHandler(),movePlacedBy();var e,t=!0;$(document).ready(function(){$(".ASM_input_holder").first().append('<span class="loading-icon loader-asm" style="display: none;"></span>')}),$("#sessionTimer").length&&$("#asmLogoutForm").length&&startTimer(),$("#resetButton").length&&$("#resetButton").click(function(){resetSession()}),placeholderNotAvailable()&&$("[placeholder]").focus(function(){var e=$(this);e.val()==e.attr("placeholder")&&(e.val(""),e.removeClass("placeholder"))}).blur(function(){var e=$(this);""!=e.val()&&e.val()!=e.attr("placeholder")||(e.addClass("placeholder"),e.val(e.attr("placeholder")))}).blur(),$("[placeholder]").blur(function(){var e=$(this);""==e.val()&&e.attr("name")&&toggleBind(!1)}),$(".ASM_alert_cart").length&&$("input[name='cartId']").addClass("ASM-input-error"),$(".ASM_alert_customer").length&&$("input[name='customerName']").addClass("ASM-input-error"),$(".ASM_alert_cred").length&&($("input[name='username']").addClass("ASM-input-error"),$("input[name='password']").addClass("ASM-input-error")),$(".ASM_alert_create_new").length&&toggleCreateAccount(!0),$("#_asmLogin").length&&1<=(e=$("#asmLoginForm input[name='username']")).val().length&&e.parent().addClass("checked"),$("#asmLoginForm input[name='username'], #asmLoginForm input[name='password']").keyup(function(){var e=$(this.parentNode);1<=this.value.length?e.addClass("checked"):e.removeClass("checked"),checkSignInButton(e)}),$("input[name='customerName']").keyup(function(e){validateNewAccount(this),$(this).removeData("hover"),removeAsmHover(),toggleBind(!1),toggleStartSessionButton(this,!1),$(this).val().length<3&&toggleCreateAccount(!1)}),$("#_asmPersonifyForm input[name='cartId']").keyup(function(){formValidate(this,8,!0,8),isErrorDisplayed()&&($("input[name='cartId']").removeClass("ASM-input-error"),$(".ASM_alert")&&$(".ASM_alert").remove())}),$("#_asmPersonifyForm input[name='customerName']").keyup(function(){isErrorDisplayed()&&($("input[name='customerName']").removeClass("ASM-input-error"),$(".ASM_alert")&&$(".ASM_alert").remove(),""==$(this).val()&&($("input[name='cartId']").removeClass("ASM-input-error"),toggleStartSessionButton($("input[name='cartId']"),!0),$("input[name='customerId']").val(""))),""==$(this).val()&&($("input[name='cartId']").val(""),$("#asmAutoCompleteCartId").empty())}),$("#_asmPersonifyForm input[name='cartId']").blur(function(){/^\s+$/.test($(this).val())&&($(this).val(""),formValidate(this,8,!0,8))}),$("#_asmBindForm input[name='cartId']").keyup(function(e){checkCartIdFieldAndToggleBind(this)}),$("#_asmBindForm input[name='cartId']").bind("paste",function(e){var t=this;setTimeout(function(){checkCartIdFieldAndToggleBind(t)},100)}),$("input[name='customerName'], input[name='customerId']").hover(function(){var e=$(this).attr("data-hover")?jQuery.parseJSON($(this).attr("data-hover")):$(this).data("hover"),t=$(this).attr("data-hover")?"disabled":"";null!=e&&$(this).after('<div id="asmHover" class="'+t+'"><span class="name">'+e.name+'</span><span class="email">'+e.email+'</span><span class="date">'+e.date+'</span><span class="card">'+e.card+"</span></div>")},function(){removeAsmHover()}),$("#_asmPersonifyForm input[name='cartId']").autocomplete({source:function(e,t){t(carts)},appendTo:"#asmAutoCompleteCartId",autoFocus:!0,minLength:0,select:function(e,t){""==t.item.value&&e.preventDefault(),toggleStartSessionButton(this,!0)}}),$("#_asmPersonifyForm input[name='cartId']").on("click, focus",function(){$("#_asmPersonifyForm input[name='cartId']").autocomplete("search","")}),0<$("input[name='customerName']").length&&($("input[name='customerName']").keyup(function(e){e=e.keyCode;13==e&&t?($(".loader-asm").show(),t=!1):13!=e&&(t=!0)}),$("input[name='customerName']").autocomplete({source:function(e,t){$(".loader-asm").show(),$.ajax({url:document.location.href+"/assisted-service/autocomplete",dataType:"jsonp",data:{customerId:e.term},success:function(e){t(e)},error:function(e){location.reload()}}).done(function(){$(".loader-asm").hide()})},minLength:3,delay:1800,appendTo:"#asmAutoComplete",select:function(e,t){""==t.item.value?e.preventDefault():(toggleStartSessionButton(this,!0),$(this).data("hover",{name:t.item.value,email:t.item.email,card:t.item.card,date:t.item.date}),$("input[name='customerId']").val(t.item.email),carts=t.item.carts,null==$("input[name='cartId']").attr("orig_value")&&($("input[name='cartId']").val(""),null!=carts?1==carts.length?$("input[name='cartId']").val(carts[0]):($("input[name='cartId']").autocomplete("search",""),$("input[name='cartId']").focus()):(carts=[{label:"No Existing Carts",value:""}],$("input[name='cartId']").autocomplete("search",""),$("input[name='cartId']").focus())),toggleBind(!0))}}).data("ui-autocomplete")._renderItem=function(e,t){return""==t.value?(toggleCreateAccount(!0),$("<li></li>").data("item.autocomplete",t).append("<a><span class='noresult'>No Customer ID found</span></a>").appendTo(e)):(toggleCreateAccount(!1),$("<li></li>").data("item.autocomplete",t).append("<a><span class='name'>"+t.value+"</span><span class='email'>"+t.email+"</span><span class='date'>"+t.date+"</span><span class='card'>"+t.card+"</span></a>").appendTo(e))}),$("#_asmBindForm").length&&(e=$("input[name='customerName']").attr("readonly"),$(".cartId input").attr("disabled"),"readonly"===e&&$(".ASM_icon-chain").removeClass("invisible").addClass("ASM_chain-bind")),$(".add_to_cart_form").length&&""==$("#_asm input[name='cartId']").val()&&$(".add_to_cart_form").submit(function(e){setTimeout(function(){var e=ACC.config.encodedContextPath+"/assisted-service/add-to-cart";$.post(e,function(e){$("#_asm").replaceWith(e),addASMHandlers()})},400)}),enableAsmPanelButtons()}function addASMFormHandler(){$&&$(".asmForm").length&&$(".asmForm").each(function(){$(this).submit(function(){return $(this).find("[placeholder]").each(function(){var e=$(this);e.val()==e.attr("placeholder")&&e.val("")}),$.ajax({type:"POST",url:$(this).attr("action"),data:$(this).serialize(),success:function(e){$("#_asm").replaceWith(e),addASMHandlers()}}),!1})})}function addCloseBtnHandler(){$("#_asm .closeBtn").click(function(){var e=ACC.config.encodedContextPath+"/assisted-service/quit";$.post(e,function(e){var t=window.location.href.replace("&asm=true","").replace("?asm=true&","?").replace("?asm=true","");window.location.replace(t)})})}function addHideBtnHandler(){$("#_asm .ASM_control_collapse").click(function(){$("#_asm").toggleClass("ASM-collapsed")})}function startTimer(){sessionSec=timer,clearInterval(counter),counter=setInterval(timerFunc,1e3)}function timerFunc(){if(sessionSec<=0)return clearInterval(counter),void finishASMagentSession();sessionSec-=1;var e=Math.floor(sessionSec/60),t=sessionSec%60;e<10&&(e="0"+e),t<10&&(t="0"+t),$("#sessionTimer .ASM_timer_count").html(e+":"+t)}function resetSession(){var e=$.ajax({url:ACC.config.contextPath+"/assisted-service/resetSession",type:"POST"});e.done(function(e){sessionSec=timer+1}),e.fail(function(e,t){$("#errors").empty(),$("#errors").append("Request failed: "+t)})}function finishASMagentSession(){$.ajax({url:ACC.config.encodedContextPath+"/assisted-service/logoutasm",type:"POST",success:function(e){$("#_asm").replaceWith(e),addASMHandlers()}})}function isStartEmulateButtonPresent(){return 1==$(".ASM-btn-start-session").length}function enableAsmPanelButtons(){$('div[id="_asm"] button').not(".ASM-btn-start-session, .ASM-btn-create-account, .ASM-btn-login").removeAttr("disabled"),isStartEmulateButtonPresent()&&(""!=$("#_asmPersonifyForm input[name='customerId']").val()&&$("#_asmPersonifyForm input[name='customerId']").parent().addClass("checked"),formValidate($("#_asmPersonifyForm input[name='cartId']")[0],8,!0,8))}function placeholderNotAvailable(){return!("placeholder"in document.createElement("input"))}function removeAsmHover(){$("#asmHover").remove()}function toggleCreateAccount(e){var t=$(".ASM_icon-chain"),a=$("#_asmCreateAccountForm button.ASM-btn-create-account[type='submit']");e?(a.removeClass("hidden"),t.removeClass("invisible")):(a.addClass("hidden"),t.addClass("invisible"))}function toggleActivationState(e,t){t?e.removeAttr("disabled"):e.attr("disabled","")}function checkSignInButton(e){var t=$("#asmLoginForm button[type='submit']");toggleActivationState(t,1<$(e).parent().find(".checked").length)}function checkStartSessionButton(e){toggleStartSessionButton(e,!1),0<$(e.parentNode).siblings(".checked").length&&toggleActivationState($("button.ASM-btn-start-session"),!0)}function checkCartIdFieldAndToggleBind(e){if(!$(e).hasClass("placeholder")&&0<$("input[name='customerId']").val().length&&!isNaN(e.value)&&8==e.value.length&&e.value!=e.getAttribute("orig_value"))return $("#_asmBindForm button[type='submit']").removeClass("hidden"),void $(".ASM_icon-chain").removeClass("invisible");$("#_asmBindForm button[type='submit']").addClass("hidden"),$(".ASM_icon-chain").addClass("invisible")}function toggleBind(e){var t,a;$("#_asmBindForm").length&&(t=$(".ASM_icon-chain"),a=$("#_asmBindForm button.ASM-btn-bind-cart[type='submit']"),e?(a.removeClass("hidden"),t.removeClass("invisible")):(a.addClass("hidden"),$(".ASM-btn-create-account").hasClass("hidden")&&t.addClass("invisible")))}function toggleStartSessionButton(e,t){var e=$(e).parent(),a=$("button.ASM-btn-start-session");t?(a.removeAttr("disabled"),e.addClass("checked")):(a.attr("disabled",""),e.removeClass("checked"))}function formValidate(e,t,a,n){if($(e).hasClass("placeholder"))return!1;if($(e).hasClass("ASM-input-error"))return toggleStartSessionButton(e,!1),!1;if(!1!==a&&isNaN(e.value))return toggleStartSessionButton(e,!1),!1;if(e.value.length>=t)toggleStartSessionButton(e,!0),void 0!==n&&e.value.length>n&&toggleStartSessionButton(e,!1);else{if(0!==e.value.length)return toggleStartSessionButton(e,!1),!1;checkStartSessionButton(e)}return!0}function validateEmail(e){return $("<input>").attr({type:"email",required:"required"}).val(e)[0].checkValidity()&&0<e.indexOf(".")}function validateName(e){return""!=e&&/^[a-zA-Z-]+\s[a-zA-Z-]+$/.test(e)}function validateNewAccount(e){var t,a,n=$("#_asmCreateAccountForm button.ASM-btn-create-account[type='submit']"),e=e.value.split(", "),o=$("#_asmCreateAccountForm input[name='customerId']"),s=$("#_asmCreateAccountForm input[name='customerName']");return 1<e.length?(t=validateName(e[0]),a=validateEmail(e[1]),t&&a?(toggleActivationState(n,!0),o.val(e[1].replace(/^\s\s*/,"").replace(/\s\s*$/,"")),void s.val(e[0])):(toggleActivationState(n,!1),!1)):(toggleActivationState(n,!1),!1)}function revertAutocompleteNormalize(){$.ui.autocomplete.prototype._normalize=function(e){return e.length&&e[0].label&&e[0].value?e:$.map(e,function(e){return"string"==typeof e?{label:e,value:e}:$.extend({label:e.label||e.value,value:e.value||e.label},e)})}}function isErrorDisplayed(){return $(".ASM_alert").length}function addCustomerListBtnHandler(){$(".js-customer-list-btn").removeClass("disabled"),$(document).on("click",".js-customer-list-btn",function(e){e.preventDefault(),populateCustomerListModal($(this).data("actionurl"),".js-customer-list-modal-content",addCustomerListSelect)})}function customerListModalHandler(){$(document).on("click",".ASM_customer-list-modal .pagination a",function(e){e.preventDefault(),populateCustomerListModal($(this).attr("href"),".asm-account-section",replaceCustomerListTable)}),$(document).on("change",".ASM_customer-list-modal .sort-refine-bar .form-control",function(e){e.preventDefault();e=$(".js-customer-list-sorting").data("sort-url");populateCustomerListModal(e+=$(this).val(),".asm-account-section",replaceCustomerListTable)}),$(document).on("change",".js-customer-list-select",function(e){e.preventDefault();e=$(this).data("search-url");populateCustomerListModal(e+=$(this).val(),".asm-account-section",replaceCustomerListTable).done(function(){$.colorbox.resize()})})}function addCustomerListSelect(e,t){var a=$(t).find(".js-customer-list-select");$(e).html(t),searchUrl=$(t).find(".js-customer-list-select").data("search-url"),0<a[0].options.length&&(searchUrl+=a[0].options[0].value),populateCustomerListModal(searchUrl,e,appendCustomerListTable).done(function(){ACC.colorbox.open("",{href:".js-customer-list-modal-content",inline:!0,className:"ASM_customer-list-modal",width:900,scrolling:!1})})}function appendCustomerListTable(e,t){$(e).append(t)}function replaceCustomerListTable(e,t){$(e).html(t)}function populateCustomerListModal(e,t,a){return $.ajax({url:e,type:"GET",success:function(e){a(t,e)},error:function(e,t,a){console.error("Failed to get customer list. %s",a),document.location.reload()}})}function movePlacedBy(){$(".asm-placedby").length&&$(".account-consignment").length&&$(".account-consignment").prepend($(".asm-placedby"))}$(document).ready(function(){addASMHandlers()});